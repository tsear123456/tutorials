# Goal

Webcom provide you multiple authentication mechanisms. Email and password is one of them. 
You have a list of users for each namespace.

Let's revisit our chat sample in [exercise 3](https://github.com/webcom-components/tutorials/blob/master/ex3/README.md) and add authentication system.

# Create a namespace if needed

If you don't have a namespace, follow [exercise 0](https://github.com/webcom-components/tutorials/blob/master/ex0/README.md) to create it.

# Authentication

Let's start from exercise 3 [code base](https://jsbin.com/qusibi/edit?js,output)

To enable chat, uncomment the first line 

```javascript
// var ref = new Webcom('https://datasync.orange.com/base/<YOUR NAMESPACE>');
```

And replace token `<YOUR NAMESPACE>` by your namespace

Now, go to your dashboard and manage your namespace, and click on authentication tab.

Create a new user. You will use it in our chat app.

# Only authenticated users can send messages

Click on security tab. 

![security tab](https://raw.githubusercontent.com/webcom-components/tutorials/master/ex3/security.png)

This page helps you to edit security rules on your data. 

Watch out [exercise 3](https://github.com/webcom-components/tutorials/blob/master/ex4/README.md) for futher informations on security rules.

Let's constraint sending messages to authenticated users :

```json
{
  "rules": {
    ".read": true,
    "messages": {
      "$message": {
        ".write": "auth != null"
      }
    }
  }
}
```
Click on save button to confirm new rules.

# Test our rule

Returns to your JS Bin, and try to send a message.

Open the console tab in JS Bin and send a new message. It prints this kind of message:

```
"WEBCOM WARNING: set at /messages/-K29TWLWYPrzj5gMZPj9 failed: permission_denied "
```

You notice also new message is displayed in chat. It's weird ! Why ? 
 
It's because data is set at first on client and after pushed to Webcom namespace. Rules are executed only on server-side.

Once rules executed, server send reverse action to client to revert action. 
For our chat action, it triggers 'child_removed' event on `messages` node.
Go to listen this event and remove message:

```javascript
ref.child('messages').on('child_removed', function (snap) {
	var id = snap.name();
  	var m = document.querySelector('li[id="'+id+'"]');
  	messagesList.removeChild(m);
});
```

When event is fired, first, we get snapshot key generated by [push()](https://datasync.orange.com/doc/Webcom.html#push) method.
And we just have to find an list item with this value as id and remove it from the list.

Now, try to add a new message. It will appears and disappears just after ! 

# Implement authentication

Add DOM references on password field and login button.

```javascript
var pwdText = document.getElementById('password');
var btnLogin = document.getElementById('btnLogin');
```

Add login method to your JS Bin. It uses [authWithPassword](https://datasync.orange.com/doc/Webcom.html#authWithPassword) method to authenticate user.

```javascript
function login() {
  // Retrieve login and password values
  var login = nickname.value,
      password = pwdText.value;
  
  if (login && password) {
    ref.authWithPassword({
      email : login,
      password : password,
      rememberMe : false
   }, function(err, auth) {
            
      if (auth) {
        btnLogin.style.display = 'none';
      }
   });
  }
}
```
Retry to send message. Now it works !

# Final result

Check final result [here](https://jsbin.com/wurizo/edit?js,console,output)

To enable chat, uncomment the first line 

```javascript
// var ref = new Webcom('https://datasync.orange.com/base/<YOUR NAMESPACE>');
```

And replace token `<YOUR NAMESPACE>` by your namespace
